# EMS Backend Architecture

## Overview
The EMS backend is a Node.js + Express + TypeScript service backed by MongoDB (Mongoose). It exposes a REST API for authentication, employee management, departments, designations, shifts, shift assignments, attendance, payroll, reports, and dashboard analytics.

## Tech Stack
- Runtime: Node.js (TypeScript)
- Web: Express 4
- Database: MongoDB + Mongoose
- Auth: JWT (HS256)
- Validation: Zod
- Docs: Swagger UI (`/docs`)
- Logging: morgan
- CORS: configurable via `.env`
- Exports: Excel (xlsx) via ExcelJS for report endpoints

## High-Level Structure
```
src/
  app.ts                # Express app wiring (CORS, JSON, logging, routes)
  server.ts             # Boot + DB connect
  config/               # env + db connection
  middleware/           # auth, errors, validate, notFound
  routes/               # Express routers (auth, users, departments, ...)
  controllers/          # Request handlers per domain
  models/               # Mongoose schemas & indexes
  utils/                # date, pagination, excel, etc.
  services/             # business logic (e.g., payrollService)
  seed/                 # seed helpers (admin, bulk, attendance range)
  docs/                 # Swagger setup
```

## Request Lifecycle
1. HTTP request enters Express (`app.ts`).
2. CORS is enforced with `origin = env.CORS_ORIGIN`.
3. JSON body parser + morgan logging.
4. Route matching (e.g., `/api/users`).
5. Optionally `authRequired` middleware for write operations.
6. Controller handles the request, uses Mongoose models/services.
7. Errors bubble into centralized `errorHandler`.

## Authentication & Authorization
- Login: `POST /api/auth/login` → returns `{ token, user }`.
- Token: signed with `JWT_SECRET` (7d expiry) and stored by the frontend.
- Middleware: `authRequired` checks `Authorization: Bearer <token>` and populates `req.user`.
- Reads are public in this demo; writes (POST/PUT/DELETE) require a valid JWT.

## Key Modules
- Users (Employees): CRUD with soft delete (status → INACTIVE).
- Departments / Designations: CRUD and lookups, with paging + sorting.
- Shifts / EmployeeShifts: shift catalogue and user assignments with date ranges.
- Attendance: daily status with optional check-in/out and hours.
- Salary Templates: one-per-user effective template for payroll.
- Payroll: monthly payroll runs generated by service logic.
- Dashboard: KPIs, trends, breakdowns.
- Reports: Excel by default (JSON available with `?format=json`).

## Reports (Excel)
All `/api/reports/*` endpoints return Excel (.xlsx) by default using ExcelJS with clear tabular columns. JSON is still supported when `?format=json` is provided.

## Configuration
`.env` (with `.env.example` fallback):
- `PORT` (default 3000)
- `NODE_ENV`
- `MONGO_URI`
- `JWT_SECRET`
- `CORS_ORIGIN` (default `http://localhost:8080` in this project)
- Admin seed defaults (email, password, name)

## Error Handling
- Zod validation errors → 400 with `{ message }`.
- Auth errors → 401.
- Not found → 404.
- Server errors → handled by centralized `errorHandler`.

## Pagination & Sorting
- Pagination: `page`, `limit` (max 100).
- Sorting: `sortBy` (default `createdAt`), `sortOrder` (`asc`/`desc`).
- Response: `{ data: [...], meta: { total, page, limit, pages } }`.

## Data Model (Summary)
- Department: `{ _id, name, description? }`.
- Designation: `{ _id, department, title, level? }`.
- User: `{ _id, employee_code, first_name, last_name, email, phone?, department?, designation?, hire_date?, employment_status, role, password_hash }`.
- Shift: `{ _id, name, start_time, end_time, break_minutes }`.
- EmployeeShift: `{ _id, user, shift, start_date, end_date? }`.
- Attendance: `{ _id, user, att_date(date-only), status('P'|'A'|'L'|'H'), check_in?, check_out?, hours_worked? }`.
- SalaryTemplate: `{ _id, user(unique), basic_salary, allowance_fixed?, allowance_percent?, deduction_fixed?, deduction_percent?, effective_from }`.
- PayrollRun: `{ _id, user, period_year, period_month, working_days, present_days, overtime_hours, basic_salary, total_allowances, total_deductions, gross_pay, net_pay, generated_at, notes? }`.

## Seeding Strategy
- `npm run seed` → seeds admin only.
- `npm run seed:bulk` (DESTRUCTIVE): clears data, seeds 3 departments, 6 designations, 3 shifts, 20 employees, salary templates, attendance range (default 2025-08-01 → 2025-09-26), and payroll for all months in the range.
- `npm run seed:attendance:range` → adds attendance in a provided range (env `SEED_FROM`/`SEED_TO`).

## Performance & Scalability Notes
- Add indexes on common filters (e.g., `{ user, att_date }` for Attendance).
- Batch aggregation where possible (e.g., dashboard trend could be batched/grouped).
- Move Excel generation to background workers if reports become heavy.
- Consider RBAC beyond simple roles for production.

